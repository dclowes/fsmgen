/**
{%- set SM = statemachine|upper %}
{%- set sm = statemachine|lower %}
{%- set BEGIN_CODE = '{' + '{' + '{' %}
{%- set END_CODE = '}' + '}' + '}' %}
* Generated by program
 */
#include "{{sm}}.fsm.h"
#include <stdlib.h>
/* BEGIN CUSTOM: include files {{BEGIN_CODE}} */
{%- if code_blocks['include files'] is defined %}
{%- for line in code_blocks['include files'] %}
{{line}}
{%- endfor %}
{%- endif %}
/* END CUSTOM: include files {{END_CODE}} */

/**
 * private data type used in action routines
 */
typedef {{SM}}_PRIVATE_DATA *pPRIVATE_DATA;

/* Place forward declarations, used in the action code, here */
/* BEGIN CUSTOM: forward declarations {{BEGIN_CODE}} */
{%- if code_blocks['forward declarations'] is defined %}
{%- for line in code_blocks['forward declarations'] %}
{{line}}
{%- endfor %}
{%- endif %}
/* END CUSTOM: forward declarations {{END_CODE}} */

{%- for act in actions|sort(case_sensitive=True) %}

/**
 * {{SM}} Action {{act}}
 *
{%- if 'comment' in actions[act] %}
{%- for comment in actions[act]['comment'] %}
 * {{comment}}
{%- endfor %}
 *
{%- endif %}
 * @param smi       the state machine instance
 * @param state     the current state
 * @param event     the current event
 * @param pContext  event context
 * @param pPrivate  statemachine instance private data
 * @return          classification/exception or NULL
 */
static {{SM}}_EVENT {{act}}(
    {{SM}} smi,
    {{SM}}_STATE state,
    {{SM}}_EVENT event,
    void *pContext,
    void *pPrivate)
{
    {{SM}}_EVENT result = NULL;
    pPRIVATE_DATA self = (pPRIVATE_DATA) pPrivate;
    /* BEGIN CUSTOM: {{act}} action code {{BEGIN_CODE}} */
{%- if act + " action code" in code_blocks %}
{%- for line in code_blocks[act + " action code"] %}
{{line}}
{%- endfor %}
{%- endif %}
    /* END CUSTOM: {{act}} action code {{END_CODE}} */
    return result;
}
{%- endfor %}

/*
 * Initialize the Class to use these functions
 */
void {{SM}}_ClassInit(void)
{
{%- for act in actions|sort(case_sensitive=True) %}
    {{SM}}_ClassSetAction({{SM}}_ACTION_{{act}}, {{act}});
{%- endfor %}
}

/*
 * Example function to construct the instance
 * Also sets the private data and private destructor (or NULL)
 */
static {{SM}} make(
    char *name,
    {{SM}}_STATE initialState,
    void *pPrivate,
    void (*pKiller)(void *))
{
    {{SM}} smi;
    smi = {{SM}}_InstanceMake(name, initialState);
    {{SM}}_SetPrivate(smi, pPrivate, pKiller);
    return smi;
}

/* Place function definitions, used in the action code, here */
/* BEGIN CUSTOM: control code {{BEGIN_CODE}} */
{%- if code_blocks['control code'] is defined %}
{%- for line in code_blocks['control code'] %}
{{line}}
{%- endfor %}
{%- endif %}
/* END CUSTOM: control code {{END_CODE}} */

#ifdef UNIT_TEST

/* Place function definitions, used in the test code, here */
/* BEGIN CUSTOM: test code {{BEGIN_CODE}} */
{%- if code_blocks['test code'] is defined %}
{%- for line in code_blocks['test code'] %}
{{line}}
{%- endfor %}
{%- endif %}
/* END CUSTOM: test code {{END_CODE}} */

static void reportFunc({{SM}} smi, const char *fmt, ...)
{
  va_list ap;
  char buf[256];
  char *dyn;
  unsigned int l;
  int res;

  va_start(ap, fmt);
  l = vsnprintf(buf, sizeof buf, fmt, ap);
  va_end(ap);
  if (l >= sizeof buf) {
    /* we have probably a C99 conforming snprintf and
       need a larger buffer
     */
    dyn = malloc(l + 1);
    if (dyn != NULL) {
      va_start(ap, fmt);
      vsnprintf(dyn, l + 1, fmt, ap);
      va_end(ap);
      puts(dyn);
      free(dyn);
      fflush(stdout);
      return;
    }
  }
  puts(buf);
  fflush(stdout);
  return;
}

int main(int argc, char *argv[])
{
    {{SM}} smi;
    {{SM}}_PRIVATE_DATA private_data;
    {{SM}}_STATE initialState = NULL;

    {{SM}}_ClassInit();
    memset(&private_data, 0, sizeof(private_data));
    smi = make("test", initialState, &private_data, NULL);
    {{SM}}_SetReportFunc(smi, reportFunc);

    /* Place main test code here */
    /* BEGIN CUSTOM: main code {{BEGIN_CODE}} */
{%- if code_blocks['main code'] is defined %}
{%- for line in code_blocks['main code'] %}
{{line}}
{%- endfor %}
{%- endif %}
    /* END CUSTOM: main code {{END_CODE}} */

    {{SM}}_InstanceKill(smi);
    return EXIT_SUCCESS;
}

#endif /* UNIT_TEST */
#if 0 /* BEGIN PARKING LOT {{BEGIN_CODE}} */
{%- for code in code_blocks|sort(case_sensitive=True) if ' action code' in code and code.replace(' action code', '') not in actions %}
/* BEGIN CUSTOM: {{code}} {{BEGIN_CODE}} */
{%- for line in code_blocks[code] %}
{{line}}
{%- endfor %}
/* END CUSTOM: {{code}} {{END_CODE}} */
{%- endfor %}
#endif /* END PARKING LOT {{END_CODE}} */

/*
 * vim{# This spoils vim #}: ft=c ts=8 sts=4 sw=4 et cindent
 {#- vim: ft=jinja ts=8 sts=4 sw=4 et smartindent nocindent
 #}
 */
